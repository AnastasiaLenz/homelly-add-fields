<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Homelly — Поля → PDF</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141b; --text:#e8eaf0; --muted:#a7adbb; --line:#252a36; --blue:#1a6cff;
      --ok:#31d07b; --warn:#ffd37a; --bad:#ff8a7a;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:20px;display:grid;grid-template-columns:360px 1fr;gap:16px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    h1{margin:0 0 8px;font-size:18px;}
    .sub{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.35;}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;}
    input,select,button{
      width:100%;box-sizing:border-box;border:1px solid var(--line);background:#0e1016;color:var(--text);
      padding:10px 12px;border-radius:12px;outline:none;
    }
    input:focus,select:focus{border-color:#3a4257;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    button{cursor:pointer;font-weight:800;}
    button.primary{background:var(--blue);border-color:var(--blue);}
    button.ghost{background:transparent;}
    .pill{display:inline-block;padding:3px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px;}
    .list{display:grid;gap:12px;}
    .item{border:1px solid var(--line);border-radius:16px;padding:12px;background:#0e1016;}
    .itemHead{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;}
    .fn{font-weight:800;font-size:13px;line-height:1.25;}
    .meta{color:var(--muted);font-size:12px;margin-top:4px;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;align-items:start;}
    .tiny{font-size:11px;color:var(--muted);line-height:1.35;}
    .warn{color:var(--warn);font-size:12px;margin-top:10px;line-height:1.35;}
    .good{color:var(--ok);font-weight:800;}
    .muted{color:var(--muted);}
    .hr{height:1px;background:var(--line);margin:10px 0;}

    /* Preview: белая страница + белые поля + картинка, растянутая в окно */
    .pagePreview{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:#ffffff;
      overflow:hidden;
      position:relative;
    }
    .pageInner{
      position:absolute;
      background:#ffffff;
      overflow:hidden;
    }
    .imgFill{
      position:absolute;
      inset:0;
      background-position:center;
      background-repeat:no-repeat;
      background-size:100% 100%; /* растягиваем без сохранения пропорций */
    }
    .shadowLine{
      position:absolute; inset:0;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
      pointer-events:none;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <h1>Поля → PDF (4 стороны)</h1>
      <p class="sub">
        Загрузи несколько изображений → задай формат и белые поля (сверху/справа/снизу/слева) → получи один PDF.
        <br><span class="tiny">Картинки не отправляются на сервер: всё делается локально.</span>
      </p>

      <label>Загрузить изображения (JPG/PNG)</label>
      <input id="files" type="file" accept="image/jpeg,image/png" multiple />

      <div class="hr"></div>

      <label>Формат страницы (см)</label>
      <select id="pagePreset">
        <option value="21x30">21×30</option>
        <option value="30x40" selected>30×40</option>
        <option value="40x50">40×50</option>
        <option value="50x70">50×70</option>
        <option value="60x80">60×80</option>
        <option value="custom">Свой размер…</option>
      </select>

      <div class="row">
        <div>
          <label>Ширина, см</label>
          <input id="pageW" type="number" min="1" step="0.1" value="30"/>
        </div>
        <div>
          <label>Высота, см</label>
          <input id="pageH" type="number" min="1" step="0.1" value="40"/>
        </div>
      </div>

      <label>Белые поля (мм)</label>
      <div class="row">
        <div>
          <label style="margin-top:0">Слева</label>
          <input id="mLeft" type="number" min="0" step="1" value="10"/>
        </div>
        <div>
          <label style="margin-top:0">Справа</label>
          <input id="mRight" type="number" min="0" step="1" value="10"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Сверху</label>
          <input id="mTop" type="number" min="0" step="1" value="10"/>
        </div>
        <div>
          <label>Снизу</label>
          <input id="mBottom" type="number" min="0" step="1" value="10"/>
        </div>
      </div>

      <div class="hr"></div>

      <button class="primary" id="exportPdf">Собрать PDF</button>
      <p class="warn" id="status"></p>

      <p class="tiny muted">
        Картинка не обрезается и растягивается под окно внутри полей. Поля — белые.
      </p>
    </section>

    <section class="card">
      <div class="itemHead">
        <div>
          <div class="fn">Файлы</div>
          <div class="meta" id="countMeta">Пока ничего не загружено</div>
        </div>
        <span class="pill" id="libMeta">pdf-lib: loading…</span>
      </div>

      <div class="hr"></div>
      <div class="list" id="list"></div>
    </section>
  </div>

  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script>
  (() => {
    const $ = (id) => document.getElementById(id);

    const filesEl = $("files");
    const listEl = $("list");
    const countMeta = $("countMeta");
    const statusEl = $("status");

    const pagePreset = $("pagePreset");
    const pageW = $("pageW");
    const pageH = $("pageH");

    const mLeft = $("mLeft");
    const mRight = $("mRight");
    const mTop = $("mTop");
    const mBottom = $("mBottom");

    const exportBtn = $("exportPdf");
    const libMeta = $("libMeta");

    const PRESETS = {
      "21x30": { w: 21, h: 30 },
      "30x40": { w: 30, h: 40 },
      "40x50": { w: 40, h: 50 },
      "50x70": { w: 50, h: 70 },
      "60x80": { w: 60, h: 80 },
    };

    const items = []; // { id, file, bytes, mime, imgW, imgH, url }

    // helpers
    const mmToPt = (mm) => (mm / 25.4) * 72;
    const cmToPt = (cm) => (cm / 2.54) * 72;

    function currentPageCm() {
      return {
        w: Math.max(0.1, Number(pageW.value || 0)),
        h: Math.max(0.1, Number(pageH.value || 0)),
      };
    }

    function currentMarginsMm() {
      return {
        l: Math.max(0, Number(mLeft.value || 0)),
        r: Math.max(0, Number(mRight.value || 0)),
        t: Math.max(0, Number(mTop.value || 0)),
        b: Math.max(0, Number(mBottom.value || 0)),
      };
    }

    function setPresetUI(pkey) {
      if (pkey === "custom") return;
      const p = PRESETS[pkey];
      pageW.value = p.w;
      pageH.value = p.h;
      refreshPreviews();
    }

    pagePreset.addEventListener("change", () => {
      if (pagePreset.value !== "custom") setPresetUI(pagePreset.value);
    });

    [pageW, pageH, mLeft, mRight, mTop, mBottom].forEach(el => {
      el.addEventListener("input", refreshPreviews);
      el.addEventListener("change", refreshPreviews);
    });

    async function readFileBytes(file) {
      const buf = await file.arrayBuffer();
      return new Uint8Array(buf);
    }

    async function getImageDimsFromBytes(bytes, mime) {
      const blob = new Blob([bytes], { type: mime });
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.decoding = "async";
      img.src = url;
      await new Promise((res, rej) => {
        img.onload = () => res();
        img.onerror = () => rej(new Error("Не удалось прочитать изображение"));
      });
      const w = img.naturalWidth;
      const h = img.naturalHeight;
      URL.revokeObjectURL(url);
      return { w, h };
    }

    function makeItemCard(item) {
      const wrap = document.createElement("div");
      wrap.className = "item";
      wrap.dataset.id = item.id;

      const head = document.createElement("div");
      head.className = "itemHead";

      const left = document.createElement("div");
      const fn = document.createElement("div");
      fn.className = "fn";
      fn.textContent = item.file.name;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `Исходник: <span class="mono">${item.imgW}×${item.imgH}</span> • ${item.mime.replace("image/","").toUpperCase()}`;
      left.appendChild(fn);
      left.appendChild(meta);

      const delBtn = document.createElement("button");
      delBtn.className = "ghost";
      delBtn.style.width = "auto";
      delBtn.style.padding = "8px 10px";
      delBtn.textContent = "Удалить";
      delBtn.addEventListener("click", () => {
        const idx = items.findIndex(x => x.id === item.id);
        if (idx >= 0) {
          URL.revokeObjectURL(items[idx].url);
          items.splice(idx, 1);
          renderList();
        }
      });

      head.appendChild(left);
      head.appendChild(delBtn);

      const grid = document.createElement("div");
      grid.className = "grid2";

      const preview = document.createElement("div");
      preview.className = "pagePreview";

      const inner = document.createElement("div");
      inner.className = "pageInner";

      const imgFill = document.createElement("div");
      imgFill.className = "imgFill";
      imgFill.style.backgroundImage = `url("${item.url}")`;

      inner.appendChild(imgFill);
      preview.appendChild(inner);
      preview.appendChild(Object.assign(document.createElement("div"), { className: "shadowLine" }));

      const note = document.createElement("div");
      note.className = "tiny muted";
      note.innerHTML =
        `Картинка <b>растягивается</b> под окно внутри полей (без обрезки).<br/>` +
        `Поля: белые.`;

      grid.appendChild(preview);
      grid.appendChild(note);

      wrap.appendChild(head);
      wrap.appendChild(grid);

      refreshItemPreview(item, wrap);
      return wrap;
    }

    function refreshItemPreview(item, cardEl) {
      const card = cardEl || listEl.querySelector(\`.item[data-id="\${item.id}"]\`);
      if (!card) return;

      const page = currentPageCm();
      const mm = currentMarginsMm();

      // превью: задаём пропорции страницы
      const prev = card.querySelector(".pagePreview");
      const inner = card.querySelector(".pageInner");
      prev.style.aspectRatio = `${page.w} / ${page.h}`;

      // перевод мм в см
      const lCm = mm.l / 10, rCm = mm.r / 10, tCm = mm.t / 10, bCm = mm.b / 10;

      const innerWcm = page.w - lCm - rCm;
      const innerHcm = page.h - tCm - bCm;

      if (innerWcm <= 0 || innerHcm <= 0) {
        // если поля “съели” всё — покажем почти пустое окно
        inner.style.left = "49%";
        inner.style.right = "49%";
        inner.style.top = "49%";
        inner.style.bottom = "49%";
        return;
      }

      inner.style.left = `${(lCm / page.w) * 100}%`;
      inner.style.right = `${(rCm / page.w) * 100}%`;
      inner.style.top = `${(tCm / page.h) * 100}%`;
      inner.style.bottom = `${(bCm / page.h) * 100}%`;
    }

    function refreshPreviews() {
      items.forEach(it => refreshItemPreview(it));
    }

    function renderList() {
      listEl.innerHTML = "";
      items.forEach(it => listEl.appendChild(makeItemCard(it)));
      countMeta.textContent = items.length ? `Загружено: ${items.length}` : "Пока ничего не загружено";
      statusEl.textContent = "";
    }

    filesEl.addEventListener("change", async () => {
      const files = Array.from(filesEl.files || []);
      if (!files.length) return;

      statusEl.textContent = "Загружаю файлы…";

      for (const f of files) {
        if (!["image/jpeg","image/png"].includes(f.type)) continue;

        const bytes = await readFileBytes(f);
        const dims = await getImageDimsFromBytes(bytes, f.type);
        const blobUrl = URL.createObjectURL(new Blob([bytes], { type: f.type }));

        items.push({
          id: crypto.randomUUID(),
          file: f,
          bytes,
          mime: f.type,
          imgW: dims.w,
          imgH: dims.h,
          url: blobUrl,
        });
      }

      renderList();
      statusEl.textContent = items.length ? "" : "Не удалось добавить файлы (поддерживаются JPG/PNG).";
      filesEl.value = "";
    });

    exportBtn.addEventListener("click", async () => {
      statusEl.textContent = "";

      if (!window.PDFLib) {
        statusEl.textContent = "pdf-lib не загрузился. Проверь интернет/блокировки CDN.";
        return;
      }
      if (!items.length) {
        statusEl.textContent = "Сначала добавь изображения.";
        return;
      }

      const { PDFDocument, rgb } = window.PDFLib;

      const pageCm = currentPageCm();
      const mm = currentMarginsMm();

      const pageWpt = cmToPt(pageCm.w);
      const pageHpt = cmToPt(pageCm.h);

      const lPt = mmToPt(mm.l);
      const rPt = mmToPt(mm.r);
      const tPt = mmToPt(mm.t);
      const bPt = mmToPt(mm.b);

      const innerW = pageWpt - lPt - rPt;
      const innerH = pageHpt - tPt - bPt;

      if (innerW <= 0 || innerH <= 0) {
        statusEl.textContent = "Слишком большие поля — внутреннее окно стало ≤ 0.";
        return;
      }

      statusEl.textContent = "Собираю PDF…";

      const pdfDoc = await PDFDocument.create();

      for (const it of items) {
        const page = pdfDoc.addPage([pageWpt, pageHpt]);

        // белый фон
        page.drawRectangle({ x: 0, y: 0, width: pageWpt, height: pageHpt, color: rgb(1,1,1) });

        let img;
        if (it.mime === "image/jpeg") img = await pdfDoc.embedJpg(it.bytes);
        else img = await pdfDoc.embedPng(it.bytes);

        // ВАЖНО: растягиваем в окно (без сохранения пропорций), без обрезки
        page.drawImage(img, {
          x: lPt,
          y: bPt,            // в PDF ось Y снизу вверх
          width: innerW,
          height: innerH
        });
      }

      const pdfBytes = await pdfDoc.save({ useObjectStreams: true });
      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      const stamp = new Date().toISOString().slice(0,19).replaceAll(":","-");
      a.href = url;
      a.download = `homelly_margins_${pageCm.w}x${pageCm.h}_L${mm.l}R${mm.r}T${mm.t}B${mm.b}_${stamp}.pdf`;
      a.click();

      setTimeout(() => URL.revokeObjectURL(url), 5000);
      statusEl.innerHTML = `<span class="good">Готово ✅</span> PDF скачан.`;
    });

    libMeta.textContent = window.PDFLib ? "pdf-lib: OK" : "pdf-lib: loading…";
    setPresetUI(pagePreset.value);
  })();
  </script>
</body>
</html>
